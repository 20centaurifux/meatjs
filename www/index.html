<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
  <title>Loading...</title>

  <link rel="stylesheet" href="jquery.mobile-1.4.5.css">
  <link rel="stylesheet" href="jquery.blockui.css">
  <link rel="stylesheet" href="jqm-icon-pack-fa.css">

  <style>
    span.error {color:red; margin:5px; font-style:italic;}
    img.image  {border-style:dotted; border-width:1px;}
  </style>

  <script type="text/javascript" src="jquery.min.js"></script>

  <script type="text/javascript">
    $(document).bind("mobileinit", function()
    {
      $.mobile.autoInitializePage = false;
      $.mobile.defaultPageTransition = "none";
      $.mobile.toolbar.prototype.options.updatePagePadding = false;
      $.mobile.toolbar.prototype.options.hideDuringFocus = "";
      $.mobile.toolbar.prototype.options.tapToggle = false;
    });         
  </script>

  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="escape.js"></script>
  <script type="text/javascript" src="tools.js"></script>
  <script type="text/javascript" src="jquery.blockui.js"></script>
  <script type="text/javascript" src="meat.storage.js"></script>
  <script type="text/javascript" src="meat.cache.js"></script>
  <script type="text/javascript" src="meat.notifications.js"></script>
  <script type="text/javascript" src="meat.rest.js"></script>
  <script type="text/javascript" src="meat.store.js"></script>
  <script type="text/javascript" src="jquery.library.js"></script>
  <script type="text/javascript" src="jquery.friends.js"></script>
  <script type="text/javascript" src="jquery.comments.js"></script>
  <script type="text/javascript" src="jquery.messages.js"></script>
  <script type="text/javascript" src="jquery.mobile-1.4.5.min.js"></script>
  <script type="text/javascript" src="jquery.mobile.paramsHandler-1.4.2.js"></script>

  <script type="text/javascript">
    var store = null;
    var notifications = null;
    var foreground = true;

    $(document).ready(function()
    {
      document.addEventListener('deviceready', function()
      {
        // initialize store:
        store = new MeatStore();

        // register page events:
        $('div[data-role="page"]').each(function()
        {
          $(this).on("pagebeforeshow", function() { $(document).blockUI("hide"); });
        });

        $("#page-edit-profile").on("pagebeforeshow", page_profile_loading);
        $("#page-change-avatar").on("pagebeforeshow", page_change_avatar_loading);
        $("#page-reset-password").on("pagebeforeshow", page_reset_password_loading);
        $("#page-change-password").on("pagebeforeshow", page_change_password_loading);
        $("#page-authentication").on("pagebeforeshow", page_authentication_loading);
        $("#page-new-account").on("pagebeforeshow", page_new_account_loading);
        $("#page-library").on("pagebeforeshow", page_library_loading);
        $("#page-random").on("pagebeforeshow", page_random_loading);
        $("#page-random").on("pagebeforehide", page_random_unloading);
        $("#page-popular").on("pagebeforeshow", page_popular_loading);
        $("#page-friends").on("pagebeforeshow", page_friends_loading);
        $("#page-favorites").on("pagebeforeshow", page_favorites_loading);
        $("#page-messages").on("pagebeforeshow", page_messages_loading);
        $("#page-messages").on("pageshow", page_messages_loaded);
        $("#page-recommend").on("pagebeforeshow", page_recommend_loading);

        $.mobile.paramsHandler.addPage("page-image", ["guid"], [], function(params) { page_image_loaded(params.guid); });
        $.mobile.paramsHandler.init();

        // register window events:
        $(window).on("resize", window_resize);

        // setup scrolling, image scaling & tasks:
        $(document).on("pagecreate", "#page-library", function()
        {
          setupScrolling();
          setupScaling();
          setupSwipe();
          setupBackgroundMode();
          setupNotifications();
          setupTasks();
        });

        // back button:
        if(device.platform == "Android")
        {
          navigator.app.overrideBackbutton(true);
          document.addEventListener("backbutton", function() { window.history.back(); }, true);
        }

        // watch activity status changes:
        document.addEventListener("pause", function()
        {
          foreground = false;
          cordova.plugins.backgroundMode.enable();
        }, false);

        document.addEventListener("resume", function()
        {
          foreground = true;
      
          cordova.plugins.backgroundMode.disable();

          var pageId = $("body").pagecontainer("getActivePage").attr("id");

          if(pageId == "page-library")
          {
            notifications.markReceived("Library");
          }
          else if(pageId == "page-messages")
          {
            notifications.markReceived("Messages");
          }
        }, false);

        // initialize jquery mobile:
        $.mobile.initializePage();
      })});

    function setupBackgroundMode()
    {
      cordova.plugins.backgroundMode.setDefaults(
      {
        title: "meatjs",
        text: "Waiting for more meat.",
        icon: "res://logo",
        smallIcon: "res://logo"
      });
    }

    function setupNotifications()
    {
      var NOTIFICATION_MESSAGES = 1;
      var NOTIFICATION_LIBRARY  = 2;

      notifications = new MeatNotification(
      {
        onNotify: function(name, timestamp)
        {
          var id = NOTIFICATION_MESSAGES;
          var title = "New Message(s)";
          var message = "There are new messages waiting for you.";
          var data = { fgcolor: "white", bgcolor: "#2e2b6d" };

          if(name == "Library")
          {
            id = NOTIFICATION_LIBRARY;
            title = "New image(s)";
            message = "There are new images waiting for you.";
            data = { fgcolor: "white", bgcolor: "#5a5a5a" };
          }

          var notify = function()
          {
            cordova.plugins.notification.local.schedule(
            {
              id: id,
              title: title,
              message: message,
              icon: "res://logo",
              smallIcon: "res://logo",
              data: data
            });
          };

          cordova.plugins.notification.local.hasPermission(function(granted)
          {
            if(granted)
            {
              notify();
            }
            else
            {
              cordova.plugins.notification.local.registerPermission(function(granted)
              {
                if(granted)
                {
                  notify();
                }
              });
            }
          });
        }
      });

      cordova.plugins.notification.local.on("click", function(notification)
      {
        var pageId = null;

        if(notification.id == NOTIFICATION_MESSAGES)
        {
          pageId = "#page-messages";
        }
        else if(notification.id == NOTIFICATION_LIBRARY)
        {
          pageId = "#page-library";
        }

        if(pageId)
        {
          $("body").pagecontainer("change", pageId);
        }
      });

      cordova.plugins.notification.local.on("clear", function(notification)
      {
        if(notification.id == NOTIFICATION_MESSAGES)
        {
          notifications.markReceived("Messages");
        }
        else if(notification.id == NOTIFICATION_LIBRARY)
        {
          notifications.markReceived("Library");
        }
      });
    }

    function setupScrolling()
    {
      var scrollTop = 0;

      $(document).on("scrollstart", function()
      {
        scrollTop = $(window).scrollTop();
      });

      $(document).on("scrollstop", function()
      {
        var height = $(window).height();
        var top = $(window).scrollTop();

        if(top > scrollTop && $(window).scrollTop() >= $(document).height() - $(window).height())
        {
          var pageId = $("body").pagecontainer("getActivePage").attr("id");

          switch(pageId)
          {
            case "page-library":
              $("#library-listview").library("nextPage");
              break;

            case "page-popular":
              $("#popular-listview").library("nextPage");
              break;

            case "page-image":
              $("#comments-listview").comments("nextPage");
              break;
          }
        }
      });
    }

    function setupScaling()
    {
      $("#image-source").on("load", scaleImage);
    }

    function setupSwipe()
    {
      /* Using the page title is the best way to get the correct parent page id. Using the Browser's history
         doesn't work properly after opening the App from a local notification. */
      function getParentPageId()
      {
        var history = $.mobile.navigate.history.stack[$.mobile.navigate.history.stack.length - 2];
        var pageId = null;

        if(!history.title && (history.hash == "" || history.hash == "#page-library"))
        {
          history.title = "Library";
        }

        switch(history.title)
        {
          case "Library":
            pageId = "#page-library";
            break;

          case "Random":
            pageId = "#page-random";
            break;

          case "Popular":
            pageId = "#page-popular";
            break;

          case "Favorites":
            pageId = "#page-favorites";
            break;

          default:
            pageId = null;
        }

        return pageId;
      }

      $('div[data-role="page"]').each(function()
      {
        if($(this).attr("id") == "page-image")
        {
          // navigate trough image library:
          $("#page-image").on("swipeleft", function()
          {
            var pageId = getParentPageId();

            if(pageId)
            {
              var obj = $(pageId).find('ul[data-role="listview"]:first');

              $(obj).library("next");
            }
          });

          $("#page-image").on("swiperight", function()
          {
            var pageId = getParentPageId();

            if(pageId)
            {
              var obj = $(pageId).find('ul[data-role="listview"]:first');

              $(obj).library("prev", function(success)
              {
                if(!success)
                {
                  window.history.back();
                }
              });
            }
            else
            {
              window.history.back();
            }
          });
        }
        else
        {
          $(this).on("swiperight", function()
          {
            // navigation trough window history:
            window.history.back();
          });
        }
      });
    }

    function setupTasks()
    {
      setInterval(function()
      {
        if(store.configured())
        {
          try
          {
            page_messages_update_task();
          }
          catch(e) {}

          try
          {
            page_library_update_task();
          }
          catch(e) {}

          try
          {
            cordova.plugins.backgroundMode.configure({ text: "Waiting for more meat." });
          }
          catch(e) {}
        }
      }, 5 * 60 * 1000);
    }

    function window_resize()
    {
      var pageId = $("body").pagecontainer("getActivePage").attr("id");

      if(pageId == "page-image")
      {
        scaleImage();
      }
    }

    function openNavigation()
    {
      $("body").pagecontainer("change", "#page-navigation");
    }

    function initializeAccount()
    {
      store.setConfigured();

      notifications.enable("Messages");
      notifications.enable("Library");
    }

    /*
     *  authentication page:
     */
    function page_authentication_loading()
    {
      var credentials = store.getCredentials();

      $("#page-authentication").find(".error").hide();

      if(store.configured())
      {
        $("#text-authentication-username").val(credentials.Username);
        $("#text-authentication-password").val(credentials.Password);
        $("#link-authentication-back").show();
        $("#link-authentication-connect").text("Reconnect");
        $("#link-authentication-new-account").hide();
      }
      else
      {
        $("#link-authentication-back").hide();
        $("#link-authentication-connect").text("Login");
        $("#link-authentication-new-account").show();
      }
    }

    function link_authentication_connect_tapped()
    {
      $(document).blockUI("show");

      $("#page-authentication").find(".error").hide();

      var username = $("#text-authentication-username").val();
      var password = $("#text-authentication-password").val();

      store.changeCredentials(username, password)
        .done(function(profile)
        {
          var message = "You're connected now. Have fun :)";
          var title = "Login";

          if(store.configured())
          {
            message = "You've been reconnected. Have fun :)";
            title = "Reconnected";
          }
          else
          {
            initializeAccount();
          }

          navigator.notification.alert(message,
                                       function() { location.replace("index.html#page-library"); },
                                       title, "Ok");
        })
        .fail(function(response)
        {
          var text;

          if(response.status == 404)
          {
            text = "User account not found. Please check entered username.";
          }
          else if(response.status == 403)
          {
            text = "Invalid username or password.";
          }
          else
          {
            text = Tools.getFailureMessage(response);
          }

          $("#page-authentication").find(".error").first().text("*" + text).show();
        })
        .always(function()
        {
          $(document).blockUI("hide")
        });
    }

    /*
     *  password reset page:
     */
    function page_reset_password_loading()
    {
      $(document).blockUI("show");

      $("#page-reset-password").find(".error").hide();

      // test password reset timeout:
      var expired = store.lastPasswordResetTimeoutExpired(120);

      if(expired)
      {
        $("#link-reset-password").prop("disabled", false).removeClass("ui-disabled");
        $("#text-reset-password-username").textinput("enable");
        $("#text-reset-password-email").textinput("enable");
        $("#p-reset-password-timeout").hide();
      }
      else
      {
        $("#link-reset-password").prop("disabled", true).addClass("ui-disabled");
        $("#text-reset-password-username").textinput("disable");
        $("#text-reset-password-email").textinput("disable");
        $("#p-reset-password-timeout").show();
      }

      // try to fill username & email field:
      store.getOwnProfile()
        .done(function(profile)
        {
          $("#text-reset-password-username").val(profile["username"]);
          $("#text-reset-password-email").val(profile["email"]);
          $("#text-reset-password-username").textinput("disable");
        })
        .fail(function()
        {
          $("#text-reset-password-username").val("");
          $("#text-reset-password-email").val("");
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    function link_reset_password_tapped()
    {
      $(document).blockUI("show");

      $("#page-authentication").find(".error").hide();

      var username = $("#text-authentication-username").val();
      var password = $("#text-authentication-password").val();

      store.changeCredentials(username, password)
        .done(function(profile)
        {
          var message = "You're connected now. Have fun :)";
          var title = "Login";

          if(store.configured())
          {
            message = "You've been reconnected. Have fun :)";
            title = "Reconnected";
          }

          navigator.notification.alert(message,
                                       function() { store.setConfigured(); $("body").pagecontainer("change", "#page-library", { changeHash:false }); },
                                       title, "Ok");
        })
        .fail(function(response)
        {
          var text;

          if(response.status == 404)
          {
            text = "User account not found. Please check entered username.";
          }
          else if(response.status == 403)
          {
            text = "Invalid username or password.";
          }
          else
          {
            text = Tools.getFailureMessage(response);
          }

          $("#page-authentication").find(".error").first().text("*" + text).show();
        })
        .always(function()
        {
          $(document).blockUI("hide")
        });
    }

    /*
     *  password reset page:
     */
    function page_reset_password_loading()
    {
      $(document).blockUI("show");

      $("#page-reset-password").find(".error").hide();

      // test password reset timeout:
      var expired = store.lastPasswordResetTimeoutExpired(120);

      if(expired)
      {
        $("#link-reset-password").prop("disabled", false).removeClass("ui-disabled");
        $("#text-reset-password-username").textinput("enable");
        $("#text-reset-password-email").textinput("enable");
        $("#p-reset-password-timeout").hide();
      }
      else
      {
        $("#link-reset-password").prop("disabled", true).addClass("ui-disabled");
        $("#text-reset-password-username").textinput("disable");
        $("#text-reset-password-email").textinput("disable");
        $("#p-reset-password-timeout").show();
      }

      // try to fill username & email field:
      store.getOwnProfile()
        .done(function(profile)
        {
          $("#text-reset-password-username").val(profile["username"]);
          $("#text-reset-password-email").val(profile["email"]);
          $("#text-reset-password-username").textinput("disable");
        })
        .fail(function()
        {
          $("#text-reset-password-username").val("");
          $("#text-reset-password-email").val("");
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    function link_reset_password_tapped()
    {
      $(document).blockUI("show");

      $("#page-authentication").find(".error").hide();

      var username = $("#text-authentication-username").val();
      var password = $("#text-authentication-password").val();

      store.changeCredentials(username, password)
        .done(function(profile)
        {
          var message = "You're connected now. Have fun :)";
          var title = "Login";

          if(store.configured())
          {
            message = "You've been reconnected. Have fun :)";
            title = "Reconnected";
          }

          navigator.notification.alert(message,
                                       function() { store.setConfigured(); $("body").pagecontainer("change", "#page-library", { changeHash:false }); },
                                       title, "Ok");
        })
        .fail(function(response)
        {
          var text;

          if(response.status == 404)
          {
            text = "User account not found. Please check entered username.";
          }
          else if(response.status == 403)
          {
            text = "Invalid username or password.";
          }
          else
          {
            text = Tools.getFailureMessage(response);
          }

          $("#page-authentication").find(".error").first().text("*" + text).show();
        })
        .always(function()
        {
          $(document).blockUI("hide")
        });
    }

    /*
     *  password reset page:
     */
    function page_reset_password_loading()
    {
      $(document).blockUI("show");

      $("#page-reset-password").find(".error").hide();

      // test password reset timeout:
      var expired = store.lastPasswordResetTimeoutExpired(120);

      if(expired)
      {
        $("#link-reset-password").prop("disabled", false).removeClass("ui-disabled");
        $("#text-reset-password-username").textinput("enable");
        $("#text-reset-password-email").textinput("enable");
        $("#p-reset-password-timeout").hide();
      }
      else
      {
        $("#link-reset-password").prop("disabled", true).addClass("ui-disabled");
        $("#text-reset-password-username").textinput("disable");
        $("#text-reset-password-email").textinput("disable");
        $("#p-reset-password-timeout").show();
      }

      // try to fill username & email field:
      store.getOwnProfile()
        .done(function(profile)
        {
          $("#text-reset-password-username").val(profile["username"]);
          $("#text-reset-password-email").val(profile["email"]);
          $("#text-reset-password-username").textinput("disable");
        })
        .fail(function()
        {
          $("#text-reset-password-username").val("");
          $("#text-reset-password-email").val("");
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    function link_reset_password_tapped()
    {
      $(document).blockUI("show");

      $("#page-reset-password").find(".error").hide();

      var username = $("#text-reset-password-username").val();
      var email = $("#text-reset-password-email").val();

      store.requestPassword(username, email)
        .done(function(profile)
        {
          navigator.notification.alert("You'll receive a password reset mail within the next few minutes.",
                                       function() { window.history.back(); }, "Password reset", "Ok");
        })
        .fail(function(response)
        {
          var field = Tools.findInvalidField(response);

          if(response.status == 422 || field == "email")
          {
            $("#page-reset-password").find('.error[data-field="email"]').text("*The specified mail address is invalid.").show();
          }
          else if(response.status == 404)
          {
            $("#page-reset-password").find('.error[data-field="username"]').text("*User not found.").show();
          }
          else
          {
            $("#page-reset-password").find(".error").first().text("*" + Tools.getFailureMessage(response)).show();
          }
        })
        .always(function()
        {
          $(document).blockUI("hide")
        });
    }

    /*
     *  register new account page:
     */
    function page_new_account_loading()
    {
      $("#page-new-account").find(".error").hide();

      var expired = store.lastAccountRequestTimeoutExpired(60);

      if(expired)
      {
        $("#link-new-account").prop("disabled", false).removeClass("ui-disabled");
        $("#text-new-account-username").val("").textinput("enable");
        $("#text-new-account-email").val("").textinput("enable");
        $("#p-new-account-wait").hide();
      }
      else
      {
        $("#link-new-account").prop("disabled", true).addClass("ui-disabled");
        $("#text-new-account-username").textinput("disable");
        $("#text-new-account-email").textinput("disable");
        $("#p-new-account-wait").show();
      }
    }

    function link_new_account_tapped()
    {
      $(document).blockUI("show");

      $("#page-new-account").find(".error").hide();

      var username = $("#text-new-account-username").val();
      var email = $("#text-new-account-email").val();

      store.requestAccount(username, email)
        .done(function()
        {
          navigator.notification.alert("Your account has been registered successfully. You'll receive an activiation mail within " +
                                       "the next few minutes.",
                                       function() { $("body").pagecontainer("change", "#page-authentication", { changeHash:false }); },
                                       "Password sent", "Ok");
        })
        .fail(function(response)
        {
          var field = Tools.findInvalidField(response);
          var text;

          if(field == "email")
          {
            text = "Please check the entered mail address.";
          }
          else if(field == "username")
          {
            text = "Please enter a name with a maximum length of 32 characters.";
          }
          else if(response.status == 409)
          {
            message = "Username or mail address already in use."
          }
          else
          {
            message = Tools.getFailureMessage(response);
          }

          if(field)
          {
            $("#page-new-account").find('span[data-field="' + field + '"]').text("*" + text).show();
          }
          else
          {
            $("#page-new-account").find(".error").first().text("*" + message).show();
          }
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    /*
     *  edit profile page:
     */
    function page_profile_loading()
    {
      $(document).blockUI("show");

      $("#page-edit-profile").find(".error").hide();

      store.getOwnProfile()
        .done(function(profile)
        {
          $("#text-profile-email").val(profile["email"]);
          $("#text-profile-firstname").val(profile["firstname"]);
          $("#text-profile-lastname").val(profile["lastname"]);
          $("#select-profile-language").val(profile["language"]);
          $("#select-profile-sex").val(profile["gender"]).selectmenu("refresh");
          $("#checkbox-profile-protected").prop("checked", profile["protected"]).checkboxradio("refresh");
        }).fail(function(response)
        {
          $("#page-edit-profile").find(".error").first().text("*Couldn't load profile, please try again.").show();
        }).always(function()
        {
          $(document).blockUI("hide");
        });
    }

    function link_profile_save_tapped()
    {
      $(document).blockUI("show");

      store.updateProfile($("#text-profile-email").val(),
                          $("#text-profile-firstname").val(),
                          $("#text-profile-lastname").val(),
                          $("#select-profile-language").val(),
                          $("#select-profile-sex").val(),
                          $("#checkbox-profile-protected").is(":checked"))
        .done(function(profile)
        {
          $("#page-edit-profile").find(".error").hide();
        })
        .fail(function(response)
        {
          var field = Tools.findInvalidField(response);
          var text;

          if(field == "email")
          {
            text = "Please check the entered mail address.";
          }
          else if(field == "firstname" || field == "lastname")
          {
            text = "Please enter a name with a maximum length of 32 characters.";
          }
          else
          {
            message = Tools.getFailureMessage(response);
          }

          if(field)
          {
            $("#page-edit-profile").find('span[data-field="' + field + '"]').text("*" + text).show();
          }
          else
          {
            $("#pagedit-profile").find(".error").first().text("*" + message).show();
          }
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    /*
     *  change avatar page:
     */
    function page_change_avatar_loading()
    {
      $("#image-avatar").hide();
      $("#page-change-avatar").find(".error").hide();

      store.getOwnAvatar()
        .done(function(image)
        {
          $("#image-avatar").attr("src", image).fadeIn();
        })
        .fail(function(result)
        {
          if(result.status != 404)
          {
            $("#page-change-avatar").find(".error").first().text("*" + Tools.getFailureMessage(result)).show();
          }
        });
    }

    function link_avatar_take_picture_tapped()
    {
      if(navigator.camera)
      {
        var opts =
        {
          quality:30,
          destinationType:Camera.DestinationType.DATA_URL,
          sourceType:Camera.PictureSourceType.CAMERA,
          encodingType:Camera.EncodingType.PNG,
          targetWidth:480,
          targetHeight:480,
          correctOrientation:true
        };

        navigator.camera.getPicture(function(image)
        {
          $("#image-avatar").attr("src", "data:image/png;base64," + image).fadeIn();
        }, function()
        {
          navigator.notification.alert("Error taking picture.", null, "Take picture", "Ok");
        }, opts);
      }
      else
      {
        navigator.notification.alert("Camera not found.", null, "Take picture", "Ok");
      }
    }

    function link_avatar_upload_tapped()
    {
      var dataUrl = $("#image-avatar").attr("src");
      var arr = dataUrl.split(",");
      var mime = arr[0].match(/:(.*?);/)[1];
      var bstr = atob(arr[1]);
      var n = bstr.length;
      var u8arr = new Uint8Array(n);

      while(n--)
      {
        u8arr[n] = bstr.charCodeAt(n);
      }

      var file = new Blob([u8arr], {type:mime});

      if(file != null)
      {
        $(document).blockUI("show");
        $("#page-change-avatar").find(".error").hide();

        if(file)
        {
          store.uploadAvatar(file)
            .fail(function(result)
            {
              $("#page-change-avatar").find(".error").first().text("*" + Tools.getFailureMessage(result)).show();
            })
            .always(function()
            {
              $(document).blockUI("hide");
            });
        }
      }
    }

    /*
     *  change password page:
     */
    function page_change_password_loading()
    {
      $("#page-change-password").find(".error").hide();
    }

    function link_change_password_tapped()
    {
      $(document).blockUI("show");

      var new_password1 = $("#text-change-password-new1").val();
      var new_password2 = $("#text-change-password-new2").val();

      $("#page-change-password").find(".error").hide();

      store.updatePassword(new_password1, new_password2)
        .done(function(profile)
        {
          $("#page-change-password").find(".error").hide();

          navigator.notification.alert("Password changed successfully.",
                                       function() { window.history.back(); }, "Password changed", "Ok");
        })
        .fail(function(response)
        {
          var field = Tools.findInvalidField(response);
          var text;

          if(field == "new_password1")
          {
            text = "Your password should be between 8 and 32 characters.";
          }
          else if(field == "new_password2")
          {
            text = "Both passwords have to be equal.";
          }
          else
          {
            text = Tools.getFailureMessage(response);
          }

          if(field)
          {
            $("#page-change-password").find('span[data-field="' + field + '"]').text("*" + text).show();
          }
          else
          {
            $("#page-change-password").find(".error").first().text("*" + text).show();
          }
        })
        .always(function()
        {
          $(document).blockUI("hide");
        });
    }

    function updateLibraries(ids, objects)
    {
      $(ids).each(function()
      {
        var el = $("#" + this);

        $(objects).each(function()
        {
          $(el).library("touch", this, false, true);
        });
      });
    }

    function updateAllLibraries(objects)
    {
      updateLibraries(["library-listview", "random-listview", "popular-listview", "favorites-listview"], objects);
    }

    /*
     * library:
     */
    function build_library_opts()
    {
      var opts =
      {
        requestLimit: 60,
        pageSize: 10,
        onLoad: function(page, pageSize)
        {
          return store.getObjects(page, pageSize).done(function(objects)
          {
            updateLibraries(["popular-listview", "favorites-listview"], objects);
          });
        },
        onCompare: function(a, b)
        {
          return b["created_on"]["$date"] - a["created_on"]["$date"]
        },
        onSelect: openImage
      };

      return opts;
    }

    function page_library_loading()
    {
      if(store.configured())
      {
        $("#library-listview").library(build_library_opts()).library("update");

        if(notifications)
        {
          notifications.markReceived("Library");
        }
      }
      else
      {
        $("body").pagecontainer("change", "#page-authentication", { changeHash: false });
      }
    }

    function page_library_update_task()
    {
      var pageId = $("body").pagecontainer("getActivePage").attr("id");

      cordova.plugins.backgroundMode.configure({ text: "Searching for new images." });

      if(notifications.enabled("Library") && (pageId != "page-library" || !foreground))
      {
        var opts = build_library_opts();

        opts["silent"] = true;
        opts["onNewImage"] = function(image)
        {
          notifications.feed("Library", Tools.toUTC(new Date(image["created_on"]["$date"])).getTime());
        };

        $("#library-listview").library(opts).library("update");
      }
    }

    /*
     * random:
     */
    function page_random_loading()
    {
      $("#random-listview").library(
      {
        requestLimit: 0,
        pageSize: 10,
        onLoad: function(page, pageSize)
        {
          return store.getRandom(pageSize).done(function(objects)
          {
            updateLibraries(["library-listview", "popular-listview", "favorites-listview"], objects);
          });
        },
        onSelect: openImage
      });

      $("#random-listview").library("update");
    }

    function page_random_unloading()
    {
      $("#random-listview").library("clear");
    }

    /*
     * popular:
     */
    function page_popular_loading()
    {
      $("#popular-listview").library(
      {
        requestLimit: 180,
        pageSize: 10,
        onLoad: function(page, pageSize)
        {
          return store.getPopular(page, pageSize).done(function (objects)
          {
            updateLibraries(["library-listview", "favorites-listview"], objects);
          });
        },
        onCompare: function(a, b)
        {
          var score_a = a["score"]["up"] - a["score"]["down"] + a["score"]["fav"];
          var score_b = b["score"]["up"] - b["score"]["down"] + b["score"]["fav"];

          return score_b - score_a || b["created_on"]["$data"] - a["created_on"]["$data"];
        },
        onSelect: openImage
      });

      $("#popular-listview").library("update");
    }

    /*
     * favorites:
     */
    function page_favorites_loading()
    {
      $("#favorites-listview").library(
      {
        requestLimit: 300,
        onLoad: function(page, pageSize)
        {
          var d = $.Deferred();

          if(page > 0)
          {
            d.resolve([]);
          }
          else
          {
            store.getFavorites()
              .done(function(objects)
              {
                d.resolve(objects);
                updateLibraries(["library-listview", "popular-listview"], objects);
              })
              .fail(d.reject);
          }

          return d.promise();
        },
        onCompare: function(a, b)
        {
          return b["created_on"]["$date"] - a["created_on"]["$date"]
        },
        onSelect: openImage
      });

      $("#favorites-listview").library("update");
    }

    /*
     * image details page:
     */
    function page_image_loaded(guid)
    {
      var guidExists = function(objects, guid)
      {
        var contains = false;

        $(objects).each(function()
        {
          if(this["guid"] == guid)
          {
            contains = true;
          }

          return !contains;
        });

        return contains;
      };

      setTimeout(function() { $.mobile.loading("show"); }, 150);

      $("#image-source").hide();
      $("#p-image-details").hide();
      $("#image-action-buttons").hide();
      $("#form-add-comment").hide();

      $.when(store.getObject(guid), store.getVote(guid), store.getFavorites(), store.getOwnProfile())
        .done(function(obj, vote, favorites, profile)
        {
          obj = obj[0];

          // update image in all libraries:
          updateAllLibraries(obj);

          // disable all buttons:
          $("#image-action-buttons").find("button").prop("disabled", true).addClass("ui-disabled");

          // load image:
          store.getImage(obj["source"])
            .done(function(data)
            {
              // update image:
              $("#image-source").attr("src", data).show();

              // update details:
              $("#image-score-up").text(obj["score"]["up"]);
              $("#image-score-down").text(obj["score"]["down"]);
              $("#image-score-favorite").text(obj["score"]["fav"]);

              $("#p-image-details").show();

              // setup buttons:
              $("#image-action-buttons").show();

              if(!obj["locked"])
              {
                if(vote["up"] == null)
                {
                  $("#image-button-like").prop("disabled", false).removeClass("ui-disabled");
                  $("#image-button-dislike").prop("disabled", false).removeClass("ui-disabled");
                }
                else
                {
                  $("#image-button-like").prop("disabled", true).addClass("ui-disabled");
                  $("#image-button-dislike").prop("disabled", true).addClass("ui-disabled");
                }

                $("#image-button-favorite .ui-icon").removeClass("ui-icon-star ui-icon-star-o");

                var favorite = guidExists(favorites, guid);

                $("#image-button-favorite")
                  .removeClass("ui-icon-star ui-icon-star-o")
                  .attr("data-icon", favorite ? "star" : "star-o")
                  .addClass(favorite ? "ui-icon-star" : "ui-icon-star-o")
                  .trigger("refresh");

                if(guidExists(favorites, guid))
                {
                  $("#image-button-favorite").attr("data-icon", "star");
                }
                else
                {
                  $("#image-button-favorite").attr("data-icon", "star-o");
                }

                $("#image-button-favorite").prop("disabled", false).removeClass("ui-disabled");
                $("#image-button-write-comment").prop("disabled", false).removeClass("ui-disabled");

                if(profile.following.length > 0)
                {
                  $("#image-button-recommend").show();
                  $("#image-button-recommend").prop("disabled", false).removeClass("ui-disabled");
                }
                else
                {
                  $("#image-button-recommend").hide();
                }

                $("#image-button-open").prop("disabled", false).removeClass("ui-disabled");

                // assign guid to buttons:
                $("#image-action-buttons").find("button").data("guid", obj["guid"]);
              }

              // comments:
              $("#comments-listview").comments(
              {
                pageSize: 10,
                onLoad: function(page, pageSize)
                {
                  return store.getComments(guid, page, pageSize);
                },
                onGetAvatar: store.getAvatar
              });

              $("#button-add-comment").prop("disabled", true).addClass("ui-disabled").data("guid", obj["guid"]);

              $("#textarea-comment").off("keyup").on("keyup", function()
              {
                if($("#textarea-comment").val().length > 0)
                {
                  $("#button-add-comment").prop("disabled", false).removeClass("ui-disabled").button("refresh");
                }
                else
                {
                  $("#button-add-comment").prop("disabled", true).addClass("ui-disabled").button("refresh");
                }
              }).val("");
            })
            .fail(function(result)
            {
              navigator.notification.alert("Couldn't load image, please try again.", null, "Request failed", "Ok");
            })
            .always(function()
            {
              setTimeout(function() { $(document).blockUI("hide"); }, 150);
            })
        })
        .fail(function(result)
        {
          setTimeout(function() { $(document).blockUI("hide"); }, 150);

          navigator.notification.alert("Couldn't load image details, please try again.", null, "Request failed", "Ok");
        })
    }

    function scaleImage()
    {
      var maxHeight = $(window).height() - 60 + "px";
      var maxWidth = $(window).width() - 60 + "px";

      $("#image-source").css({"max-height": maxHeight, "max-width": maxWidth});
    }

    function openImage(guid)
    {
      $("body").pagecontainer("change", "#page-image?guid=" + guid);
    }

    function button_like_tapped(guid, like)
    {
      $.mobile.loading("show");

      store.like(guid, like)
        .done(function(image)
        {
          updateAllLibraries([image]);

          // update like/dislike buttons:
          $("#image-button-like").prop("disabled", true).addClass("ui-disabled");
          $("#image-button-dislike").prop("disabled", true).addClass("ui-disabled");

          // update displayed details:
          $("#image-score-up").text(image["score"]["up"]);
          $("#image-score-down").text(image["score"]["down"]);
          $("#image-score-favorite").text(image["score"]["fav"]);
        })
        .always(function()
        {
          $.mobile.loading("hide");
        });
    }

    function button_favor_tapped(guid, favor)
    {
      $.mobile.loading("show");

      store.favor(guid, favor)
        .done(function(image)
        {
          updateLibraries(["library-listview", "random-listview", "popular-listview", "favorites-listview"], [image]);

          if(favor)
          {
            $("#favorites-listview").library("touch", image, true, true);
          }
          else
          {
            $("#favorites-listview").library("remove", image);
          }

          // update favorite button:
          $("#image-button-favorite")
            .removeClass("ui-icon-star ui-icon-star-o")
            .attr("data-icon", favor ? "star" : "star-o")
            .addClass(favor ? "ui-icon-star" : "ui-icon-star-o")
            .trigger("refresh");

          // update displayed details:
          $("#image-score-up").text(image["score"]["up"]);
          $("#image-score-down").text(image["score"]["down"]);
          $("#image-score-favorite").text(image["score"]["fav"]);
        })
        .always(function()
        {
          $.mobile.loading("hide");
        });
    }

    function button_write_comment_tapped()
    {
      $("#form-add-comment").show();
      $("#textarea-comment").val("").focus();
      $("#button-add-comment").prop("disabled", true).addClass("ui-disabled").button("refresh");
    }

    function button_add_comment_tapped(btn)
    {
      var guid = $(btn).data("guid");
      var text = $("#textarea-comment").val();

      $.mobile.loading("show");

      $("#form-add-comment").hide();

      store.addComment(guid, text)
        .done(function(image)
        {
          $("#textarea-comment").val("");
          $("#form-add-comment").hide();

          updateLibraries(["library-listview", "random-listview", "popular-listview", "favorites-listview"], [image]);

          $("#comments-listview").comments("update");
        })
        .always(function()
        {
          $.mobile.loading("hide");
        });
    }

    function button_recommend_tapped(guid)
    {
      $("body").pagecontainer("change", "#page-recommend");
      $("#link-send-recommendations").data("guid", guid);
    }

    function link_send_recommendations_tapped(guid)
    {
      var usernames = new Array();

      $("#recommend-to-listview li").each(function(i, li)
      {
        if($(li).find("select").val() == "yes")
        {
          usernames.push($(li).data("username"));
        }

        if(usernames.length > 0)
        {
          $.mobile.loading("show");

          store.createClient().recommend(guid, usernames)
            .success(function()
            {
              window.history.back();
            })
            .fail(function(result)
            {
              navigator.notification.alert("Couldn't recommend image, please try again.", null, "Request failed", "Ok");
            })
            .always(function()
            {
              $.mobile.loading("hide");
            });
        }
      });
    }

    function button_open_image_tapped(guid)
    {
      var b64 = $("#image-source").attr("src");
      var token = b64.split(",");
      var type = token[0].split("/")[1].toLowerCase().replace(";base64", "");

      window.FullScreenImage.showImageBase64(token[1], guid, type);
    }

    /*
     *  recommend page:
     */
    function page_recommend_loading()
    {
      var client = store.createClient();
      var ul = $("#recommend-to-listview");

      ul.find("li").remove();
      ul.listview();

      $(document).blockUI("show");

      store.getOwnProfile()
        .done(function(profile)
        {
          $.when.apply($, $.map(profile["following"], function(friend) { return store.getProfile(friend); }))
          .done(function()
          {
            $(arguments).each(function(i, user)
            {
              // build displayed username:
              fullname = Tools.buildDisplayUsername(user);

              // insert list element:
              var li = $('<li data-username="' + user["username"].escapeQuotes() + '">' +
                         '<img data-source="' + user["username"].escapeQuotes() + '" src="images/image-loader.gif" alt="">' +
                         '<div style="float:right;"><span style="font-size:smaller; font-weight:bold;">Send</span> <select data-mini="true">' +
                         '<option value="no">No</option>' +
                         '<option value="yes">Yes</option>' +
                         '</select></div>' +
                         '<div style="float:left;"><h2>' + user["username"] + '</h2></div>' +
                         '<div style="clear:both;"></div>' +
                         fullname.escapeHTML() +
                         '</li>');

              li.find("select").flipswitch();
              ul.append(li);

              // load avatar:
              client.getAvatar(user["username"])
                .done(function(image)
                {
                  $(li).find("img").attr("src", image);
                })
                .fail(function()
                {
                  $(li).find("img").attr("src", "images/image-missing.png");
                });
            });

            ul.listview("refresh");
          })
          .fail(function()
          {
            navigator.notification.alert("Couldn't load friends, please try again.", null, "Request failed", "Ok");
          })
          .always(function()
          {
            $(document).blockUI("hide");
          });
        })
        .fail(function()
        {
          $(document).blockUI("hide");
          navigator.notification.alert("Couldn't load profile, please try again.", null, "Request failed", "Ok");
        });
    }

    /*
     * friends page: 
     */
    function page_friends_loading()
    {
      $("#page-friends").friends(
      {
        onGetProfile: store.getOwnProfile,
        onSearch: store.searchUsers,
        onGetFriends: function()
        {
          var d = $.Deferred();

          store.getOwnProfile()
            .done(function(profile)
            {
              $.when.apply($, $.map(profile["following"], function(friend) { return store.getProfile(friend); }))
                .done(function()
                {
                  d.resolve(arguments);
                })
                .fail(d.reject);
            })
            .fail(d.reject);

          return d.promise();
        },
        onChangeFriendship: store.follow,
        onGetAvatar: store.getAvatar
      });

      $("#page-friends").friends("open");
    }

    /*
     * messages page:
     */
    function build_messages_opts()
    {
      var opts =
      {
        requestLimit: 60,
        pageSize: 50,
        onLoad: store.getMessages,
        onGetThumbnail: function(source)
        {
          return store.createClient().getThumbnail(source);
        },
        onGetAvatar: store.getAvatar,
        onSelect: function(type, id)
        {
          if(type == "image")
          {
            openImage(id);
          }
          else if(type == "comment")
          {
            id = id.split(",");
            openImage(id[0]);
          }
        }
      };

      return opts;
    }

    function set_messages_opts_after_filter(opts)
    {
      var lastNotified = notifications.lastNotified("Messages");

      if(lastNotified)
      {
        opts["onLoad"] = function(limit)
        {
          return store.getMessages(limit, lastNotified);
        };
      }
    }

    function page_messages_loading()
    {
      var opts = build_messages_opts();

      if($("#page-messages").data("initialized"))
      {
        set_messages_opts_after_filter(opts);
      }

      $("#messages-listview").messages(opts);

      if(notifications)
      {
        notifications.markReceived("Messages");
      }
    }

    function page_messages_loaded()
    {
      $("#page-messages").data("initialized", true);
    }

    function page_messages_update_task()
    {
      var pageId = $("body").pagecontainer("getActivePage").attr("id");
      var background = false;

      cordova.plugins.backgroundMode.configure({ text: "Searching for new messages." });

      if(notifications.enabled("Messages") && (pageId != "page-messages" || !foreground))
      {
        var opts = build_messages_opts();

        opts["silent"] = true;
        opts["requestLimit"] = 0;
        opts["onNewMessage"] = function(msg)
        {
          notifications.feed("Messages", Tools.toUTC(new Date(msg["created_on"]["$date"])).getTime());
        };

        set_messages_opts_after_filter(opts);

        $("#messages-listview").messages(opts);
      }
    }
  </script>
</head>

<body>

<div data-role="page" id="page-library" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Library</h1>
    <a href='javascript:$("#library-listview").library("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse"></a>
  </div>
 
  <div role="main" data-role="content">
    <ul id="library-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-random" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Random</h1>
    <a href='javascript:$("#random-listview").library("clear").library("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse"></a>
  </div>
 
  <div role="main" data-role="content">
    <ul id="random-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-popular" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Popular</h1>
    <a href='javascript:$("#popular-listview").library("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse"></a>
  </div>
 
  <div role="main" data-role="content">
    <ul id="popular-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-favorites" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Favorites</h1>
    <a href='javascript:$("#favorites-listview").library("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse"></a>
  </div>
 
  <div role="main" data-role="content">
    <ul id="favorites-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-friends" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Friends</h1>
  </div>
 
  <div data-role="main" data-role="content" id="div-friends">
  </div>
</div>

<div data-role="page" id="page-image" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a data-rel="back" href="#" data-icon="back" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Image</h1>
    <a href='javascript:$("#comments-listview").comments("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse" class="ui-btn-right"></a>
  </div>

  <div role="main" data-role="content">
    <div style="width:100%; text-align:center;">
      <div>
        <img id="image-source" class="image" src="" alt="image">

        <p id="p-image-details" style="font-size:small;">
          <strong><span id="image-score-up">0</span></strong> people <strong> liked </strong> this image <br />
          <strong><span id="image-score-down">0</span></strong> people <strong> disliked </strong> this image <br />
          <strong><span id="image-score-favorite">0</span></strong> people <strong> favorited </strong> this image <br />
        </p>
      </div>
    </div>

    <div style="width:100%; text-align:center;">
      <div id="image-action-buttons" data-role="controlgroup" data-type="horizontal" data-mini="true" data-shadow="false">
        <button id="image-button-like" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="thumbs-up" onclick="button_like_tapped($(this).data('guid'), true);">Like</button>
        <button id="image-button-dislike" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="thumbs-o-down" onclick="button_like_tapped($(this).data('guid'), false);">Dislike</button>
        <button id="image-button-favorite" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="star-o" onclick="button_favor_tapped($(this).data('guid'), $(this).attr('data-icon') == 'star-o');">Favorite</button>
        <button id="image-button-recommend" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="mail-forward" onclick="button_recommend_tapped($(this).data('guid'));">Recommend</button>
        <button id="image-button-write-comment" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="pencil" onclick="button_write_comment_tapped();">Comment</button>
        <button id="image-button-open" data-shadow="false" href="#" data-role="button" data-iconpos="notext" data-icon="picture-o" onclick="button_open_image_tapped();">Comment</button>
      </div>
      </div>
    </div>

    <form id="form-add-comment">
      <div align="right">
        <input type="button" data-icon="delete" data-iconpos="notext" onclick="$(this).closest('form').hide();" />
      </div>
      <textarea name="comment" id="textarea-comment"></textarea>
      <input type="button" id="button-add-comment" value="Add comment" onclick="button_add_comment_tapped(this);" />
    </form>

    <ul id="comments-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-messages" data-position="fixed">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a href='javascript:openNavigation();' data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Messages</h1>
    <a href='javascript:$("#messages-listview").messages("update");' data-icon="refresh" data-iconpos="notext" data-direction="reverse"></a>
  </div>
 
  <div role="main" data-role="content">
    <ul id="messages-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div id="page-navigation" data-role="page" data-theme="b">
  <div role="main" class="ui-content">
    <ul data-role="listview">
      <li><a href="#page-library">Library</a></li>
      <li><a href="#page-random">Random</a></li>
      <li><a href="#page-popular">Popular</a></li>
      <li><a href="#page-favorites">Favorites</a></li>
      <li><a href="#page-friends">Friends</a></li>
      <li><a href="#page-messages">Messages</a></li>
      <li><a href="#page-edit-profile">My Profile</a></li>
      <li><a href="#page-change-avatar">Change avatar</a></li>
      <li><a href="#page-change-password">Change password</a></li>
      <li><a href="#page-authentication">Reconnect</a></li>
      <li><a href="#page-about">About</a></li>
    </ul>
  </div>
</div>

<div data-role="page" id="page-authentication">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a id="link-authentication-back" data-rel="back" data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Login</h1>
    <a href="javascript:link_authentication_connect_tapped()" id="link-authentication-connect" data-icon="user" data-theme="b""ui-btn-right">Reconnect</a>
  </div>
 
  <div role="main" data-role="content">
    <span class="error"></span>

    <label for="text-authentication-username">Username:</label>
    <input name="text-authentication-username" id="text-authentication-username" value="" type="text">

    <label for="text-authentication-password">Password:</label>
    <input name="text-authentication-password" id="text-authentication-password" value="" type="password" autocomplete="off">

    <a href="#page-reset-password" data-icon="action" data-role="button">Forgot password</a>
    <a id="link-authentication-new-account" href="#page-new-account" data-icon="user" data-role="button">New user account</a>
  </div>
</div>

<div data-role="page" id="page-reset-password">
  <div data-role="header" data-position="fixed" data-theme="b">
    <h1>Reset password</h1>
    <a href="javascript:link_reset_password_tapped()" id="link-reset-password" data-icon="mail" data-theme="b" class="ui-btn-right">Mail</a>
  </div>
 
  <div role="main" data-role="content">
    <p>
      If you should have forgot your password please enter your username and the corresponding mail address. By
      tapping the <strong>Mail</strong> button you'll receive a link for resetting your password.
    </p>

    <p id="p-reset-password-timeout" style="display:none;">
      <strong>Please wait until requesting a new password.</strong>
    </p>

    <span class="error"></span>

    <label for="text-reset-password-username">Username:</label>
    <input name="text-reset-password-username" id="text-reset-password-username" value="" type="text" disabled="disabled">
    <span class="error" data-field="username"></span>

    <label for="text-reset-password-email">Mail address:</label>
    <input name="text-reset-password-email" id="text-reset-password-email" value="" type="text">
    <span class="error" data-field="email"></span>
  </div>
</div>

<div data-role="page" id="page-new-account">
  <div data-role="header" data-position="fixed" data-theme="b">
    <h1>Registration</h1>
    <a href="javascript:link_new_account_tapped()" id="link-new-account" data-icon="user" data-theme="b" class="ui-btn-right">Register</a>
  </div>
 
  <div role="main" data-role="content">
    <p>
      To register a new user account enter a username and mail address. Then tap the <strong>Register</strong> button.
    </p>

    <p id="p-new-account-timeout" style="display:none;">
      <strong>Please wait until registering an additional user account.</strong>
    </p>

    <span class="error"></span>

    <label for="text-new-account-username">Username:</label>
    <input name="text-new-account-username" id="text-new-account-username" value="" type="text">
    <span class="error" data-field="username"></span>

    <label for="text-new-account-email">Mail address:</label>
    <input name="text-new-account-email" id="text-new-account-email" value="" type="text">
    <span class="error" data-field="email"></span>
  </div>
</div>

<div data-role="page" id="page-change-password">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a data-rel="back" data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Change password</h1>
    <a href="javascript:link_change_password_tapped()" id="link-change-password" data-icon="edit" data-theme="b" class="ui-btn-right">Change</a>
  </div>
 
  <div role="main" data-role="content">
    <span class="error"></span>

    <label for="text-change-password-new1">New password:</label>
    <input name="text-change-password-new1" id="text-change-password-new1" value="" type="password">
    <span class="error" data-field="new_password1"></span>

    <label for="text-change-password-new2">Repeat new password:</label>
    <input name="text-change-password-new2" id="text-change-password-new2" value="" type="password">
    <span class="error" data-field="new_password2"></span>
  </div>
</div>

<div data-role="page" id="page-edit-profile">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a data-rel="back" data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Edit profile</h1>
    <a href="javascript:link_profile_save_tapped()" id="link-profile-save" data-icon="edit">Save</a>
  </div>
 
  <div role="main" data-role="content">
    <form novalidate>
      <span class="error"></span>

      <label for="text-profile-email">Mail address:</label>
      <input name="email" id="text-profile-email" value="" type="text">
      <span class="error" data-field="email"></span>

      <label for="text-profile-firstname">Firstname:</label>
      <input name="firstname" id="text-profile-firstname" value="" type="text">
      <span class="error" data-field="firstname"></span>

      <label for="text-profile-lastname">Lastname:</label>
      <input name="lastname" id="text-profile-lastname" value="" type="text">
      <span class="error" data-field="lastname"></span>

      <label for="select-profile-language">Language:</label>
      <select name="language" id="select-profile-language" data-mini="true">
        <option value="en">English</option>
      </select>

      <label for="select-profile-sex">Sex:</label>
      <select name="gender" id="select-profile-sex" data-mini="true">
        <option value="">Unknown</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="trans man">Trans man</option>
        <option value="trans woman">Tran Woman</option>
      </select>

      <fieldset data-role="controlgroup">
        <legend>Protected:</legend>
        <label for="checkbox-profile-protected">Only allow friends to contact me.</label>
        <input name="checkbox-profile-protected" id="checkbox-profile-protected" type="checkbox">
      </fieldset>
    </form>
  </div>
</div>

<div data-role="page" id="page-change-avatar">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a data-rel="back" data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>Change avatar</h1>
    <a href="javascript:link_avatar_upload_tapped()" id="link-upload-avatar" data-icon="edit">Save</a>
  </div>
 
  <div role="main" data-role="content">
    <form id="form-avatar" novalidate>
      <span class="error"></span>

      <div style="text-align:center;">
        <img style="max-height:180px; max-width:180px; border-style:dotted; border-width:1px;" src="" id="image-avatar" />
      </div>

      <br />

      <a id="link-avatar-take-picture" href="javascript:link_avatar_take_picture_tapped();" data-icon="camera" data-role="button">Take picture</a>
    </form>
  </div>
</div>

<div data-role="page" id="page-recommend">
  <div data-role="header" data-position="fixed" data-theme="b">
    <h1>Recommend</h1>
    <a id="link-send-recommendations" href="javascript:link_send_recommendations_tapped($('#link-send-recommendations').data('guid'))" data-icon="edit" class="ui-btn-right">Recommend</a>
  </div>

  <div role="main" data-role="content">
    <p>
      Please select the users you want to recommend the picture to.
    </p>

    <ul id="recommend-to-listview" data-role="listview" data-inset="true">
    </ul>
  </div>
</div>

<div data-role="page" id="page-about">
  <div data-role="header" data-position="fixed" data-theme="b">
    <a data-rel="back" data-icon="bars" data-iconpos="notext" data-direction="reverse"></a>
    <h1>About</h1>
  </div>

  <div role="main" data-role="content">
    <h1>meatjs</h1>

    <p style="line-height:2;">
      version 0.1.0 <br />
      Copyright &#xa9; 2016, Sebastian Fedrau <br />
      <a href="https://github.com/20centaurifux/meatjs/" target="_blank">https://github.com/20centaurifux/meatjs/</a> <br />
      licensed under <a href="https://www.gnu.org/licenses/agpl.txt" target="_blank">AGPL v3</a>
    </p>

    <h1>meatjs icon</h1>

    <p style="line-height:2;">
      Copyright &#xa9; Killian McIlroy <br />
      <a href="https://thenounproject.com/term/sausage/12289/" target="_blank">https://thenounproject.com/term/sausage/12289/</a> <br />
      licensed under <a href="http://creativecommons.org/licenses/by/3.0/us/" target="_blank">Creative Commons 3.0</a>
    </p>
  </div>
</div>

</body>
</html>
